
### ‚ö†Ô∏è The Problem
- File systems often **modify blocks in memory** and **write them to disk later**.
- If a crash occurs before all writes complete, the **file system becomes inconsistent**.
- Critical cases:
  - i-node blocks
  - directory blocks
  - free block list/bitmap

---

### üõ†Ô∏è File-System Checkers
- Tools to **verify and repair** filesystem consistency post-crash:
  - **UNIX**: `fsck`
  - **Windows**: `sfc`
- Journaling file systems often **don‚Äôt require external checkers** after crashes.

---

### ‚úÖ Types of Consistency Checks

#### 1. **Block Consistency**
- Maintain **two tables**:
  - `use_count[block]` ‚Üí how many files use the block
  - `free_count[block]` ‚Üí how many times it's marked free

- **Scan i-nodes**, incrementing `use_count`.
- **Scan free list/bitmap**, incrementing `free_count`.

#### üîç Possible Errors:
| Error Type                  | Description                                                                 | Fix                                                                 |
|----------------------------|-----------------------------------------------------------------------------|----------------------------------------------------------------------|
| üß± **Missing block**         | Block appears in **neither table**                                          | Add to free list                                                    |
| üîÅ **Duplicate in free list**| Block listed **multiple times in free list**                                | Rebuild free list                                                   |
| üß© **Block shared in files** | Same data block used in **multiple files** (see block 5 in Fig. 4-29d)      | Allocate new block, copy content, assign to one file, report error  |

---

#### 2. **Directory Consistency**
- Maintain `link_count[i-node]` based on actual directory entries.
- Compare with stored `link_count` in i-nodes.

#### üîç Link Count Errors:
| Error Type               | Risk                                                                                      | Fix                                                        |
|--------------------------|-------------------------------------------------------------------------------------------|-------------------------------------------------------------|
| üî∫ **Too high**            | i-node never deleted; **orphaned file** wastes space                                     | Correct link count                                          |
| ‚ö†Ô∏è **Too low**             | i-node freed while **other directory still references it** ‚Üí data corruption            | Correct link count                                          |

---

### üîç Other Consistency Checks

- **Illegal i-node references**: i-node number exceeds disk limits.
- **Suspicious permissions**:
  - e.g., mode `007` (owner can't access, others can fully).
  - SETUID files in user directories.
- **Abnormally large directories**: e.g., >1000 entries.
- **Ownership inconsistencies**: files in user dirs owned by root.

---

### üßç‚Äç‚ôÇÔ∏è Protection from Users
- Example of dangerous mistake:
  ```bash
  rm * .o
  ```
  Instead of:
  ```bash
  rm *.o
  ```

- **Windows safeguard**: moves deleted files to **Recycle Bin**, allowing recovery before permanent deletion.

---
